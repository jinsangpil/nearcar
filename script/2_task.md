# 니어카 통합 플랫폼 — 개발 가이드라인 (Dev Guidelines)

## 1. 프로젝트 목표
- **핵심 가치**: "고객 → 3분 신청 / 당일 기사배정 / 진단 후 1시간 내 레포트"를 실현하는 중고차 온라인 진단 플랫폼.
- **시스템 통합**: 기존 파편화된 운영 도구(홈페이지, 구글폼, 채널톡 등)를 단일 웹 시스템으로 통합.
- **데이터 기반**: **차량 마스터 데이터(표준화된 모델 정보)**와 **외부 API(국토부/Car365)**를 활용하여 정확한 견적과 매물 정보를 제공.

---

## 2. 개발 원칙
1.  **데이터 정확성**: 차량 정보(모델, 등급, 옵션)는 고객의 주관적 입력이 아닌 **표준 마스터 데이터**를 선택하게 하여 정합성을 유지한다.
2.  **동적 가격 정책**: 패키지 가격은 고정값이 아니며, **차량 등급(Class) + 지역(Region)**에 따라 자동으로 계산되어야 한다.
3.  **외부 의존성 제어**: 국토부/Car365 API 장애 시에도 서비스 신청 자체는 가능하도록 **Fallback 처리(수동 입력 등)**를 고려한다.
4.  **운영 효율성**: 운영자는 복잡한 계산 없이 시스템이 산출한 '정산 예정액'과 '차량 정보'를 승인만 하면 되도록 자동화한다.
5.  **확장성**: V2, V3의 자동 배정 및 AI 분석 도입을 위해 **데이터 구조(Schema)**를 정규화하여 설계한다.

---

## 3. 역할별 작업 지침

### 3.1 프론트엔드 개발자 (Next.js)
**[목표]**
- 복잡한 차량 선택 과정을 직관적인 UI(Cascading Select)로 구현
- 실시간 견적 산출 반응 속도 최적화

**[핵심 작업]**
- **차량 선택 UI**: 제조사 → 모델 → 상세모델 순으로 이어지는 **계층형 필터(Cascading Dropdown)** 컴포넌트 개발.
- **견적 계산기**: 선택된 옵션/지역에 따라 서버 API를 호출하여 즉시 가격을 보여주는 UI.
- **상태 관리**: 복잡한 신청 폼 데이터(차량정보, 주소, 결제정보)를 `Zustand` 등으로 전역 관리.
- **레포트 뷰어**: JSON 데이터를 받아 PDF와 동일한 레이아웃으로 렌더링하는 모바일 친화적 뷰어.

### 3.2 백엔드 개발자 (FastAPI)
**[목표]**
- 외부 API 연동 및 데이터 표준화
- 복잡한 가격 정책 및 정산 로직의 모듈화

**[핵심 작업]**
- **Master Data API**: 차량 모델 계층 구조(Tree Structure)를 조회하는 고성능 API (Redis 캐싱 필수).
- **외부 연동 모듈**: 국토교통부(제원), Car365(이력) API 클라이언트 구현 및 예외 처리.
- **Pricing Engine**: `Base Price` + `Class Surcharge` + `Region Fee`를 합산하는 로직 구현.
- **비동기 처리**: PDF 생성, 알림톡 발송, 외부 데이터 동기화 작업을 Celery Worker로 분리.

### 3.3 디자이너 (UX/UI)
**[목표]**
- 사용자가 "내 차 정보를 찾는 과정"을 지루해하지 않도록 설계
- 신뢰감을 주는 레포트 디자인

**[핵심 작업]**
- **Select UX**: 모바일에서 3~4단계의 뎁스(Depth) 선택을 편하게 할 수 있는 UI (Bottom Sheet 등 활용).
- **가격 투명성**: 최종 결제 금액이 어떻게 산출되었는지(기본료+할증) 명확히 보여주는 영수증 UI.
- **진단 리스트**: 기사가 현장에서 한 손으로 빠르게 체크(O/X/Photo)할 수 있는 인체공학적 UI.

### 3.4 QA 담당자
**[목표]**
- 금액 계산 및 데이터 매핑의 정확성 검증

**[핵심 테스트]**
- **가격 정책**: 국산/수입, 경차/슈퍼카, 서울/제주 등 조건별 금액 계산이 1원 단위까지 정확한가?
- **외부 연동**: 국토부 API 서버가 응답하지 않을 때 시스템이 멈추지 않고 예외 처리가 되는가?
- **마스터 데이터**: 새로 추가된 차종이 필터에 정상 노출되고 신청 가능한가?

---

## 4. 범위 (Scope)

### ✅ V1 필수 포함 (Must-Have)
- **차량 마스터 데이터 구축**: 관리자 페이지에서 엑셀 업로드 또는 스크래핑 연동.
- **차량 검색/선택**: 제조사 > 모델 > 상세모델 필터링 기능.
- **기본 외부 연동**: 차량번호 입력 시 국토부 제원 조회.
- **동적 견적 시스템**: 차종 등급 및 지역에 따른 자동 할증 계산.
- **핵심 프로세스**: 신청 → 결제 → (수동)배정 → 진단 → 레포트 → 정산.

### ❌ V1 제외 (Deferred to V2)
- 완전 자동 배정 (V1은 운영자 수동 배정).
- 기사 등급별 차등 배정 알고리즘.
- 실시간 중고차 시세 분석 리포트 (V1은 침수/제원 확인만).
- B2B 파트너(딜러) 전용 페이지.

---

## 5. 작업 우선순위

### 1순위 (Core Infrastructure)
1.  **DB 설계 및 구축**: 특히 `vehicle_master`, `price_policies` 테이블 설계가 최우선.
2.  **마스터 데이터 적재**: 초기 차량 데이터(국산/수입) DB 적재.
3.  **Backend API**: 모델 조회 및 견적 산출 API 개발.

### 2순위 (User Flow)
4.  **고객 신청 화면**: 차량 선택 → 견적 확인 → 결제 연동.
5.  **기사 앱**: 배정 확인 및 체크리스트 작성 기능.
6.  **운영자 어드민**: 신청 내역 확인 및 기사 배정 기능.

### 3순위 (Add-ons)
7.  **외부 API 연동 심화**: Car365 침수 이력 조회 연동.
8.  **알림 시스템**: 카카오 알림톡 연동.
9.  **정산 관리**: 엑셀 다운로드 및 정산 내역 조회.

# 6. 라우팅 가이드 (Updated)

## 고객 (Client)
- `/`: 메인 랜딩
- `/apply/step1`: 차량 정보 입력 (번호조회/모델선택)
- `/apply/step2`: 진단 옵션 및 일정 선택 (견적 확인)
- `/apply/step3`: 결제 및 신청 완료
- `/mypage`: 신청 내역 조회
- `/report/[id]`: 진단 리포트 열람 (웹/PDF)

## 기사 (Inspector)
- `/inspector`: 대시보드 (오늘의 일정)
- `/inspector/assignments`: 신규 배정 요청 목록
- `/inspector/inspection/[id]`: 진단 수행 (체크리스트)
- `/inspector/settlements`: 정산 내역

## 운영자 (Admin)
- `/admin/dashboard`: 현황판
- `/admin/inspections`: 전체 신청 관리 (배정/취소)
- `/admin/vehicles`: **차량 마스터 데이터 관리 (모델 추가/수정)**
- `/admin/settings/prices`: **차종별/지역별 가격 정책 설정**
- `/admin/inspectors`: 기사 관리
- `/admin/settlements`: 정산 관리

---

# 7. API 연동 규칙
1.  **Auth**: 모든 요청 헤더에 `Authorization: Bearer {token}` 포함.
2.  **Caching**: `/api/vehicles/*` 계열의 마스터 데이터 조회 API는 반드시 **Redis 캐싱**을 적용한다. (TTL: 1시간 이상)
3.  **Latency**: 외부 API(국토부 등) 호출이 포함된 로직은 타임아웃(3초)을 설정하고, 실패 시 UI에 '조회 실패(직접 입력 요망)' 메시지를 전달한다.
4.  **Formatting**: 날짜/시간은 UTC 기준 ISO 8601 포맷으로 통신한다.
5.  **Response**: `{ success: boolean, data: any, error: { code, message } }` 구조 준수.

---

# 8. 코드 품질 규칙
- **Type Safety**: 프론트엔드/백엔드 간 타입 정의(Interface/Pydantic)를 일치시킨다. (가능하다면 Code Generator 활용)
- **Modularization**: 가격 계산 로직(`PricingService`)과 외부 API 로직(`ExternalApiService`)은 별도 모듈로 분리하여 유닛 테스트를 작성한다.
- **Error Logging**: 외부 API 호출 실패 로그는 별도로 수집하여 모니터링한다. (Sentry 등 활용)
- **Linting**: PR 제출 전 ESLint/Prettier 및 PEP8 검사 필수.

---

# 9. 버전별 릴리즈 체크리스트

## ✅ V1 배포 Checklist (필수)
- [ ] **데이터**: 국산/수입 주요 차종 마스터 데이터가 DB에 적재되었는가?
- [ ] **정책**: 경차~슈퍼카 등급별 추가 요금이 정확히 계산되는가?
- [ ] **연동**: 차량번호 입력 시 국토부 API를 통해 정보가 불러와지는가?
- [ ] **프로세스**: 고객 신청 -> 운영자 수동 배정 -> 기사 리포트 제출이 끊김 없이 진행되는가?
- [ ] **결제**: PG사 테스트 결제 및 취소가 정상 작동하는가?
- [ ] **보안**: 개인정보(전화번호)가 암호화되어 저장되는가?

## 🚀 V2 Checklist (고도화)
- [ ] 완전 자동 배정 시스템 (거리/등급 기반)
- [ ] 기사 정산 시스템 자동화 (PDF 명세서 발송)
- [ ] AI 기반 중고차 시세/리스크 분석 리포트
- [ ] B2B 딜러 전용 대시보드

---

# 10. 최종 개발 철학 (Updated)
- **데이터가 곧 자산이다**: 단순히 신청을 받는 것을 넘어, 차량 데이터를 정확하게 축적하는 구조를 만든다.
- **운영자는 관리만 한다**: 가격 계산, 매물 조회 등 사람이 하던 계산/검색 업무는 시스템이 대신한다.
- **속도가 생명이다**: 외부 API를 쓰더라도 사용자가 느리다고 느끼지 않도록 캐싱과 비동기 처리를 적극 활용한다.
- **기본에 충실하자**: V1에서는 화려한 AI 기능보다 "정확한 진단 접수와 배정"에 집중한다.